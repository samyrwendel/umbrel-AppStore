version: "3.7"

x-shared-env: &shared-api-worker-env
  LOG_LEVEL: INFO
  DEBUG: "false"
  FLASK_DEBUG: "false"
  SECRET_KEY: ${APP_PASSWORD}
  DEPLOY_ENV: PRODUCTION
  CONSOLE_API_URL: ""
  CONSOLE_WEB_URL: ""
  SERVICE_API_URL: ""
  APP_API_URL: ""
  APP_WEB_URL: ""
  FILES_URL: ""
  MIGRATION_ENABLED: "true"
  DB_USERNAME: postgres
  DB_PASSWORD: ${APP_PASSWORD}
  DB_HOST: umbrel-br-dify_db_1
  DB_PORT: "5432"
  DB_DATABASE: dify
  REDIS_HOST: umbrel-br-dify_redis_1
  REDIS_PORT: "6379"
  REDIS_PASSWORD: ${APP_PASSWORD}
  REDIS_DB: "0"
  CELERY_BROKER_URL: redis://:${APP_PASSWORD}@umbrel-br-dify_redis_1:6379/1
  STORAGE_TYPE: opendal
  OPENDAL_SCHEME: fs
  OPENDAL_FS_ROOT: storage
  VECTOR_STORE: weaviate
  WEAVIATE_ENDPOINT: http://umbrel-br-dify_weaviate_1:8080
  WEAVIATE_API_KEY: ${APP_PASSWORD}
  SANDBOX_API_KEY: ${APP_PASSWORD}
  CODE_EXECUTION_ENDPOINT: http://umbrel-br-dify_sandbox_1:8194
  CODE_EXECUTION_API_KEY: ${APP_PASSWORD}
  SSRF_PROXY_HTTP_URL: http://umbrel-br-dify_ssrf_proxy_1:3128
  SSRF_PROXY_HTTPS_URL: http://umbrel-br-dify_ssrf_proxy_1:3128
  # Plugin daemon configuration
  PLUGIN_DAEMON_URL: http://umbrel-br-dify_plugin_daemon_1:5002
  PLUGIN_DAEMON_KEY: ${APP_PASSWORD}
  INNER_API_KEY_FOR_PLUGIN: ${APP_PASSWORD}
  PLUGIN_DIFY_INNER_API_KEY: ${APP_PASSWORD}
  PLUGIN_DIFY_INNER_API_URL: http://umbrel-br-dify_api_1:5001
  ENDPOINT_URL_TEMPLATE: http://umbrel-br-dify_nginx_1/e/{hook_id}
  MARKETPLACE_ENABLED: "true"
  MARKETPLACE_API_URL: https://marketplace.dify.ai
  FORCE_VERIFYING_SIGNATURE: "true"
  ENFORCE_LANGGENIUS_PLUGIN_SIGNATURES: "true"
  # Disable new user registration (only admin can invite)
  # First admin account uses INIT_PASSWORD from Umbrel credentials
  ALLOW_REGISTER: "false"
  INIT_PASSWORD: ${APP_PASSWORD}

services:
  app_proxy:
    environment:
      APP_HOST: umbrel-br-dify_nginx_1
      APP_PORT: 80
      PROXY_AUTH_ADD: "false"

  # Dify API Server
  api:
    image: langgenius/dify-api:1.10.1
    restart: on-failure
    user: root
    environment:
      <<: *shared-api-worker-env
      MODE: api
    depends_on:
      - db
      - redis
      - weaviate
    volumes:
      - ${APP_DATA_DIR}/data/storage:/app/api/storage

  # Dify Worker
  worker:
    image: langgenius/dify-api:1.10.1
    restart: on-failure
    user: root
    environment:
      <<: *shared-api-worker-env
      MODE: worker
    depends_on:
      - db
      - redis
      - weaviate
    volumes:
      - ${APP_DATA_DIR}/data/storage:/app/api/storage

  # Dify Web Frontend
  web:
    image: langgenius/dify-web:1.10.1
    restart: on-failure
    environment:
      CONSOLE_API_URL: ""
      APP_API_URL: ""
      NEXT_TELEMETRY_DISABLED: "1"
      TEXT_GENERATION_TIMEOUT_MS: "60000"

  # PostgreSQL Database
  db:
    image: postgres:15-alpine
    restart: on-failure
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${APP_PASSWORD}
      POSTGRES_DB: dify
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - ${APP_DATA_DIR}/data/db:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres"]
      interval: 5s
      timeout: 5s
      retries: 30

  # Database for Plugin Daemon (creates dify_plugin database)
  db_plugin_init:
    image: postgres:15-alpine
    restart: "no"
    environment:
      PGPASSWORD: ${APP_PASSWORD}
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        until pg_isready -h umbrel-br-dify_db_1 -U postgres; do
          echo "Waiting for PostgreSQL..."
          sleep 2
        done
        psql -h umbrel-br-dify_db_1 -U postgres -tc "SELECT 1 FROM pg_database WHERE datname = 'dify_plugin'" | grep -q 1 || psql -h umbrel-br-dify_db_1 -U postgres -c "CREATE DATABASE dify_plugin"
        echo "Database dify_plugin ready"
    depends_on:
      db:
        condition: service_healthy

  # Redis Cache
  redis:
    image: redis:6-alpine
    restart: on-failure
    command: redis-server --requirepass ${APP_PASSWORD}
    volumes:
      - ${APP_DATA_DIR}/data/redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${APP_PASSWORD}", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10

  # Weaviate Vector Database
  weaviate:
    image: semitechnologies/weaviate:1.27.0
    restart: on-failure
    environment:
      QUERY_DEFAULTS_LIMIT: "25"
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: "false"
      AUTHENTICATION_APIKEY_ENABLED: "true"
      AUTHENTICATION_APIKEY_ALLOWED_KEYS: ${APP_PASSWORD}
      AUTHENTICATION_APIKEY_USERS: dify@umbrel.local
      PERSISTENCE_DATA_PATH: /var/lib/weaviate
      DEFAULT_VECTORIZER_MODULE: none
      CLUSTER_HOSTNAME: node1
      AUTHORIZATION_ADMINLIST_ENABLED: "false"
    volumes:
      - ${APP_DATA_DIR}/data/weaviate:/var/lib/weaviate

  # Code Sandbox
  sandbox:
    image: langgenius/dify-sandbox:0.2.12
    restart: on-failure
    environment:
      API_KEY: ${APP_PASSWORD}
      GIN_MODE: release
      WORKER_TIMEOUT: "15"
      ENABLE_NETWORK: "true"
      HTTP_PROXY: http://umbrel-br-dify_ssrf_proxy_1:3128
      HTTPS_PROXY: http://umbrel-br-dify_ssrf_proxy_1:3128
      SANDBOX_PORT: "8194"
    volumes:
      - ${APP_DATA_DIR}/data/sandbox/dependencies:/dependencies
      - ${APP_DATA_DIR}/data/sandbox/conf:/conf
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8194/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Plugin Daemon
  plugin_daemon:
    image: langgenius/dify-plugin-daemon:0.4.1-local
    restart: on-failure
    user: root
    environment:
      <<: *shared-api-worker-env
      DB_DATABASE: dify_plugin
      SERVER_PORT: "5002"
      SERVER_KEY: ${APP_PASSWORD}
      MAX_PLUGIN_PACKAGE_SIZE: "52428800"
      PPROF_ENABLED: "false"
      DIFY_INNER_API_URL: http://umbrel-br-dify_api_1:5001
      DIFY_INNER_API_KEY: ${APP_PASSWORD}
      PLUGIN_REMOTE_INSTALLING_HOST: "0.0.0.0"
      PLUGIN_REMOTE_INSTALLING_PORT: "5003"
      PLUGIN_WORKING_PATH: /app/storage/cwd
      FORCE_VERIFYING_SIGNATURE: "true"
      PYTHON_ENV_INIT_TIMEOUT: "120"
      PLUGIN_MAX_EXECUTION_TIMEOUT: "600"
      PLUGIN_STDIO_BUFFER_SIZE: "1024"
      PLUGIN_STDIO_MAX_BUFFER_SIZE: "5242880"
      PLUGIN_STORAGE_TYPE: local
      PLUGIN_STORAGE_LOCAL_ROOT: /app/storage
      PLUGIN_INSTALLED_PATH: plugin
      PLUGIN_PACKAGE_CACHE_PATH: plugin_packages
      PLUGIN_MEDIA_CACHE_PATH: assets
    volumes:
      - ${APP_DATA_DIR}/data/plugin_daemon:/app/storage
    depends_on:
      db:
        condition: service_healthy
      db_plugin_init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5002/"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # SSRF Proxy
  ssrf_proxy:
    image: ubuntu/squid:latest
    restart: on-failure
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        cat > /etc/squid/squid.conf << 'SQUIDEOF'
        acl localnet src 0.0.0.1-0.255.255.255
        acl localnet src 10.0.0.0/8
        acl localnet src 100.64.0.0/10
        acl localnet src 169.254.0.0/16
        acl localnet src 172.16.0.0/12
        acl localnet src 192.168.0.0/16
        acl SSL_ports port 443
        acl Safe_ports port 80
        acl Safe_ports port 21
        acl Safe_ports port 443
        acl Safe_ports port 1025-65535
        acl CONNECT method CONNECT
        http_access deny !Safe_ports
        http_access deny CONNECT !SSL_ports
        http_access allow localhost
        http_access allow localnet
        http_access deny all
        http_port 3128
        coredump_dir /var/spool/squid
        refresh_pattern . 0 20% 4320
        SQUIDEOF
        exec squid -N

  # Nginx Reverse Proxy
  nginx:
    image: nginx:latest
    restart: on-failure
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        cat > /etc/nginx/nginx.conf << 'NGINXEOF'
        user nginx;
        worker_processes auto;
        error_log /var/log/nginx/error.log notice;
        pid /var/run/nginx.pid;
        events { worker_connections 1024; }
        http {
            include /etc/nginx/mime.types;
            default_type application/octet-stream;
            sendfile on;
            keepalive_timeout 65;
            client_max_body_size 100M;
            server {
                listen 80;
                server_name _;
                proxy_set_header Host $$host;
                proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $$scheme;
                proxy_http_version 1.1;
                proxy_set_header Connection "";
                proxy_buffering off;
                proxy_read_timeout 3600s;
                proxy_send_timeout 3600s;
                location /console/api { proxy_pass http://umbrel-br-dify_api_1:5001; }
                location /api { proxy_pass http://umbrel-br-dify_api_1:5001; }
                location /v1 { proxy_pass http://umbrel-br-dify_api_1:5001; }
                location /files { proxy_pass http://umbrel-br-dify_api_1:5001; }
                location /explore { proxy_pass http://umbrel-br-dify_web_1:3000; }
                location /e/ { proxy_pass http://umbrel-br-dify_plugin_daemon_1:5002; }
                location /mcp { proxy_pass http://umbrel-br-dify_api_1:5001; }
                location /triggers { proxy_pass http://umbrel-br-dify_api_1:5001; }
                location / { proxy_pass http://umbrel-br-dify_web_1:3000; }
            }
        }
        NGINXEOF
        exec nginx -g 'daemon off;'
    depends_on:
      - api
      - web
