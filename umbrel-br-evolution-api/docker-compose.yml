version: "3.7"

services:
  app_proxy:
    environment:
      APP_HOST: umbrel-br-evolution-api_server_1
      APP_PORT: 8080
      PROXY_AUTH_WHITELIST: "/webhook/*,/instance/*"

  server:
    image: atendai/evolution-api:v2.1.1
    restart: on-failure
    volumes:
      - ${APP_DATA_DIR}/data/instances:/evolution/instances
      - ${APP_DATA_DIR}/data/store:/evolution/store
    stop_grace_period: 1m
    environment:
      # Server Config
      - SERVER_URL=http://${DEVICE_DOMAIN_NAME}
      - SERVER_PORT=8080

      # Authentication
      - AUTHENTICATION_API_KEY=evolution_api_key_umbrel
      - AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES=true

      # Database (using SQLite by default)
      - DATABASE_ENABLED=true
      - DATABASE_PROVIDER=sqlite
      - DATABASE_CONNECTION_URI=file:./store/evolution.db
      - DATABASE_SAVE_DATA_INSTANCE=true
      - DATABASE_SAVE_DATA_NEW_MESSAGE=true
      - DATABASE_SAVE_MESSAGE_UPDATE=true
      - DATABASE_SAVE_DATA_CONTACTS=true
      - DATABASE_SAVE_DATA_CHATS=true
      - DATABASE_SAVE_DATA_LABELS=true
      - DATABASE_SAVE_DATA_HISTORIC=true

      # Log
      - LOG_LEVEL=ERROR
      - LOG_COLOR=true
      - LOG_BAILEYS=error

      # CORS
      - CORS_ORIGIN=*
      - CORS_METHODS=GET,POST,PUT,DELETE
      - CORS_CREDENTIALS=true

      # Instance Config
      - DEL_INSTANCE=false
      - DEL_TEMP_INSTANCES=true

      # Webhook Global
      - WEBHOOK_GLOBAL_ENABLED=false
      - WEBHOOK_GLOBAL_URL=
      - WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS=false

      # QR Code Config
      - QRCODE_LIMIT=30
      - QRCODE_COLOR=#000000

      # TypeBot Integration
      - TYPEBOT_ENABLED=true
      - TYPEBOT_API_VERSION=latest

      # Chatwoot Integration
      - CHATWOOT_ENABLED=true

      # Cache
      - CACHE_REDIS_ENABLED=false
      - CACHE_LOCAL_ENABLED=true
