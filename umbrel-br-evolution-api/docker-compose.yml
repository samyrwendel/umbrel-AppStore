version: "3.7"

services:
  app_proxy:
    environment:
      APP_HOST: umbrel-br-evolution-api_server_1
      APP_PORT: 8080
      PROXY_AUTH_WHITELIST: "/webhook/*,/instance/*,/manager/*,/socket.io/*"

  server:
    image: evoapicloud/evolution-api:latest
    restart: on-failure
    volumes:
      - ${APP_DATA_DIR}/data/instances:/evolution/instances
      - ${APP_DATA_DIR}/data/store:/evolution/store
    stop_grace_period: 1m
    environment:
      # Server Config
      - SERVER_URL=http://${DEVICE_DOMAIN_NAME}
      - SERVER_PORT=8080
      - SERVER_TYPE=http

      # Authentication
      - AUTHENTICATION_API_KEY=429683C4C977415CAAFCCE10F7D57E11
      - AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES=true

      # Database - PostgreSQL
      - DATABASE_PROVIDER=postgresql
      - DATABASE_CONNECTION_URI=postgresql://evolution:evolution@umbrel-br-evolution-api_postgres_1:5432/evolution?schema=public
      - DATABASE_CONNECTION_CLIENT_NAME=evolution_umbrel
      - DATABASE_SAVE_DATA_INSTANCE=true
      - DATABASE_SAVE_DATA_NEW_MESSAGE=true
      - DATABASE_SAVE_MESSAGE_UPDATE=true
      - DATABASE_SAVE_DATA_CONTACTS=true
      - DATABASE_SAVE_DATA_CHATS=true
      - DATABASE_SAVE_DATA_LABELS=true
      - DATABASE_SAVE_DATA_HISTORIC=true
      - DATABASE_SAVE_IS_ON_WHATSAPP=true
      - DATABASE_SAVE_IS_ON_WHATSAPP_DAYS=7
      - DATABASE_DELETE_MESSAGE=true

      # Log
      - LOG_LEVEL=ERROR,WARN
      - LOG_COLOR=true
      - LOG_BAILEYS=error

      # CORS
      - CORS_ORIGIN=*
      - CORS_METHODS=GET,POST,PUT,DELETE
      - CORS_CREDENTIALS=true

      # Instance Config
      - DEL_INSTANCE=false

      # WebSocket - HABILITADO
      - WEBSOCKET_ENABLED=true
      - WEBSOCKET_GLOBAL_EVENTS=true

      # Webhook Global
      - WEBHOOK_GLOBAL_ENABLED=false
      - WEBHOOK_GLOBAL_URL=
      - WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS=false

      # QR Code Config
      - QRCODE_LIMIT=30
      - QRCODE_COLOR=#175197
      - CONFIG_SESSION_PHONE_CLIENT=Evolution API
      - CONFIG_SESSION_PHONE_NAME=Chrome

      # TypeBot Integration
      - TYPEBOT_ENABLED=true
      - TYPEBOT_API_VERSION=latest

      # Chatwoot Integration
      - CHATWOOT_ENABLED=true
      - CHATWOOT_MESSAGE_READ=true
      - CHATWOOT_MESSAGE_DELETE=true
      - CHATWOOT_BOT_CONTACT=true

      # N8N Integration
      - N8N_ENABLED=true

      # EvoAI Integration
      - EVOAI_ENABLED=false

      # Dify Integration
      - DIFY_ENABLED=false

      # Cache - Redis
      - CACHE_REDIS_ENABLED=true
      - CACHE_REDIS_URI=redis://umbrel-br-evolution-api_redis_1:6379/6
      - CACHE_REDIS_TTL=604800
      - CACHE_REDIS_PREFIX_KEY=evolution
      - CACHE_LOCAL_ENABLED=false

      # Telemetry
      - TELEMETRY_ENABLED=false

      # Language
      - LANGUAGE=pt-BR

  redis:
    image: redis:latest
    restart: on-failure
    command: redis-server --appendonly yes
    volumes:
      - ${APP_DATA_DIR}/data/redis:/data

  postgres:
    image: postgres:15
    restart: on-failure
    environment:
      - POSTGRES_USER=evolution
      - POSTGRES_PASSWORD=evolution
      - POSTGRES_DB=evolution
    volumes:
      - ${APP_DATA_DIR}/data/postgres:/var/lib/postgresql/data
