version: '3'

services:
  app:
    image: node:20-alpine
    restart: unless-stopped
    command: 
      - sh
      - -c
      - |
        echo "ğŸš€ P2P TrustScore Bot v4.5.0 - DEVDEPENDENCIES CORRETAS..."
        apk add --no-cache git
        if [ ! -d /app/.git ]; then
          echo "ğŸ“¥ Clonando repositÃ³rio..."
          git clone https://github.com/samyrwendel/p2ptruscore.git /app
        else
          echo "ğŸ”„ Atualizando cÃ³digo..."
          cd /app && git pull origin main
        fi
        cd /app
        echo "ğŸ“¦ Instalando TODAS as dependÃªncias (prod + dev)..."
        npm install --include=dev
        echo "ğŸ”§ Verificando se devDependencies foram instaladas..."
        npm list cross-env @nestjs/cli @types/node || echo "âš ï¸ Algumas devDependencies faltando"
        echo "ğŸŒ Iniciando servidor NestJS em modo desenvolvimento..."
        npm run start:dev || echo "âŒ start:dev falhou, tentando alternativas..."
        npm run start || echo "âŒ start falhou, tentando ts-node..."
        npx ts-node src/main.ts || echo "âŒ Todas as tentativas falharam"
    ports:
      - "3000:3000"
    volumes:
      - ${APP_DATA_DIR}/data:/data
    environment:
      NODE_ENV: production
