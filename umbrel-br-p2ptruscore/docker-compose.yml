version: '3'

services:
  app:
    image: node:20-alpine
    restart: unless-stopped
    command: 
      - sh
      - -c
      - |
        echo "üöÄ P2P TrustScore Bot v5.2.0 - PRODU√á√ÉO REAL (build for√ßado)..."
        apk add --no-cache git
        if [ ! -d /app/.git ]; then
          echo "üì• Clonando reposit√≥rio..."
          git clone https://github.com/samyrwendel/p2ptruscore.git /app
        else
          echo "üîÑ Atualizando c√≥digo..."
          cd /app && git pull origin main
        fi
        cd /app
        echo "üì¶ FOR√áANDO instala√ß√£o de devDependencies no UmbrelOS..."
        npm install --include=dev --force
        echo "üîß Instalando depend√™ncias cr√≠ticas globalmente..."
        npm install -g @nestjs/cli cross-env ts-node typescript
        echo "üîç Verificando instala√ß√µes..."
        which cross-env || echo "‚ùå cross-env n√£o encontrado"
        which nest || echo "‚ùå nest n√£o encontrado" 
        which ts-node || echo "‚ùå ts-node n√£o encontrado"
        echo "üèóÔ∏è FOR√áANDO build para produ√ß√£o (ignorando erros de tipo)..."
        nest build --skip-type-check || npx @nestjs/cli build --skip-type-check || npx tsc --skipLibCheck --outDir dist
        echo "üîç Verificando se build de produ√ß√£o foi criado..."
        if [ -f "/app/dist/main.js" ]; then
          echo "‚úÖ Build de produ√ß√£o criado! Iniciando modo produ√ß√£o..."
          NODE_ENV=production node dist/main.js
        else
          echo "‚ùå Build falhou mesmo com skip-type-check, tentando compila√ß√£o manual..."
          npx tsc --skipLibCheck --noEmitOnError false --outDir dist src/main.ts
          if [ -f "/app/dist/main.js" ]; then
            echo "‚úÖ Compila√ß√£o manual funcionou! Modo produ√ß√£o..."
            NODE_ENV=production node dist/main.js
          else
            echo "‚ùå Usando ts-node como √∫ltimo recurso..."
            NODE_ENV=production npx ts-node src/main.ts
          fi
        fi
    ports:
      - "3000:3000"
    volumes:
      - ${APP_DATA_DIR}/data:/data
    environment:
      NODE_ENV: production
      # Vari√°veis tempor√°rias para permitir inicializa√ß√£o
      TELEGRAM_BOT_TOKEN: "CONFIGURE_VIA_WEB"
      TELEGRAM_BOT_USERNAME: "CONFIGURE_VIA_WEB"
      MONGODB_CNN: "mongodb://admin:umbrel@mongo:27017/p2ptruscore?authSource=admin"
      PORT: "3000"
