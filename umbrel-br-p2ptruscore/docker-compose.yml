version: '3'

services:
  bot:
    image: node:18-alpine
    restart: unless-stopped
    
    command: >
      sh -c "
        cd /app &&
        if [ ! -f package.json ]; then
          echo 'Primeira execução - Clonando repositório...' &&
          apk add --no-cache git &&
          git clone https://github.com/samyrwendel/p2ptruscore.git . &&
          echo 'Instalando dependências...' &&
          npm install &&
          echo 'Compilando aplicação...' &&
          npm run build
        fi &&
        echo 'P2P TrustScore Bot - Iniciando...' &&
        if [ -f /data/.env ]; then
          cp /data/.env /app/.env
        fi &&
        npm run start:prod || echo 'Bot precisa ser configurado - veja o README'"
    
    volumes:
      - ${APP_DATA_DIR}/app:/app
      - ${APP_DATA_DIR}/data:/data
    
    environment:
      NODE_ENV: production
      PORT: 3000
      MONGODB_CNN: mongodb://admin:umbrel@host.docker.internal:27017/p2ptruscore?authSource=admin
    
    ports:
      - "${APP_HOST_PORT}:3000"