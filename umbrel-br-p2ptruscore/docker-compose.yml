version: '3'

services:
  app_proxy:
    environment:
      APP_HOST: app
      APP_PORT: 3000

  app:
    image: node:20-alpine
    restart: unless-stopped
    command: 
      - sh
      - -c
      - |
        echo "🚀 P2P TrustScore Bot v4.0.0 - CÓDIGO REAL com interface web..."
        apk add --no-cache git
        if [ ! -d /app/.git ]; then
          echo "📥 Clonando repositório..."
          git clone https://github.com/samyrwendel/p2ptruscore.git /app
        else
          echo "🔄 Atualizando código..."
          cd /app && git pull origin main
        fi
        cd /app
        echo "📦 Instalando dependências..."
        npm install
        echo "🏗️ Compilando projeto..."
        npm run build
        echo "🌐 Iniciando servidor com interface de configuração..."
        echo "✅ Acesse /api/config para configurar o bot"
        npm run start:prod
    volumes:
      - ${APP_DATA_DIR}/data:/data
    environment:
      NODE_ENV: production
