version: '3'

services:
  app:
    image: node:20-alpine
    restart: unless-stopped
    command: 
      - sh
      - -c
      - |
        echo "ğŸš€ P2P TrustScore Bot v5.1.0 - MODO PRODUÃ‡ÃƒO AUTOMÃTICO..."
        apk add --no-cache git
        if [ ! -d /app/.git ]; then
          echo "ğŸ“¥ Clonando repositÃ³rio..."
          git clone https://github.com/samyrwendel/p2ptruscore.git /app
        else
          echo "ğŸ”„ Atualizando cÃ³digo..."
          cd /app && git pull origin main
        fi
        cd /app
        echo "ğŸ“¦ FORÃ‡ANDO instalaÃ§Ã£o de devDependencies no UmbrelOS..."
        npm install --include=dev --force
        echo "ğŸ”§ Instalando dependÃªncias crÃ­ticas globalmente..."
        npm install -g @nestjs/cli cross-env ts-node typescript
        echo "ğŸ” Verificando instalaÃ§Ãµes..."
        which cross-env || echo "âŒ cross-env nÃ£o encontrado"
        which nest || echo "âŒ nest nÃ£o encontrado" 
        which ts-node || echo "âŒ ts-node nÃ£o encontrado"
        echo "ğŸ—ï¸ Compilando para produÃ§Ã£o..."
        nest build || npx @nestjs/cli build || npx tsc
        echo "ğŸ” Verificando se compilaÃ§Ã£o foi bem-sucedida..."
        if [ -f "/app/dist/main.js" ]; then
          echo "âœ… CompilaÃ§Ã£o bem-sucedida! Iniciando em modo produÃ§Ã£o..."
          node dist/main.js
        else
          echo "âŒ CompilaÃ§Ã£o falhou, iniciando em modo desenvolvimento..."
          npx ts-node src/main.ts
        fi
    ports:
      - "3000:3000"
    volumes:
      - ${APP_DATA_DIR}/data:/data
    environment:
      NODE_ENV: production
      # VariÃ¡veis temporÃ¡rias para permitir inicializaÃ§Ã£o
      TELEGRAM_BOT_TOKEN: "CONFIGURE_VIA_WEB"
      TELEGRAM_BOT_USERNAME: "CONFIGURE_VIA_WEB"
      MONGODB_CNN: "mongodb://admin:umbrel@mongo:27017/p2ptruscore?authSource=admin"
      PORT: "3000"
