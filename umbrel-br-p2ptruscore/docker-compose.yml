version: '3'

services:
  app:
    image: node:20-alpine
    restart: unless-stopped
    working_dir: /app
    command: >
      sh -c "
        apk add --no-cache git &&
        if [ ! -d .git ]; then
          git clone https://github.com/samyrwendel/p2ptruscore.git .
        fi &&
        npm install &&
        echo 'CRIANDO .env com valores funcionais...' &&
        cat > .env << 'EOF'
TELEGRAM_BOT_TOKEN=CONFIGURE_VIA_WEB_INTERFACE
TELEGRAM_BOT_USERNAME=CONFIGURE_VIA_WEB_INTERFACE  
MONGODB_CNN=mongodb://localhost:27017/p2ptruscore
PORT=3000
NODE_ENV=production
JWT_SECRET=umbrel-p2p-secret-key-2025
WEBHOOK_URL=http://localhost:3000/webhook
API_URL=http://localhost:3000/api
EOF
        echo '.env criado:' && cat .env &&
        npx ts-node --transpile-only src/main.ts
      "
    ports:
      - "3000:3000"
    volumes:
      - ${APP_DATA_DIR}/data:/data
