version: '3'

services:
  app_proxy:
    environment:
      APP_HOST: app
      APP_PORT: 3000

  app:
    image: node:20-alpine
    restart: unless-stopped
    command: 
      - sh
      - -c
      - |
        echo "ğŸš€ P2P TrustScore Bot v4.0.1 - CORREÃ‡ÃƒO BUILD..."
        apk add --no-cache git
        if [ ! -d /app/.git ]; then
          echo "ğŸ“¥ Clonando repositÃ³rio..."
          git clone https://github.com/samyrwendel/p2ptruscore.git /app
        else
          echo "ğŸ”„ Atualizando cÃ³digo..."
          cd /app && git pull origin main
        fi
        cd /app
        echo "ğŸ“¦ Instalando dependÃªncias..."
        npm install
        echo "ğŸ”§ Instalando NestJS CLI globalmente..."
        npm install -g @nestjs/cli
        echo "ğŸ—ï¸ Compilando projeto com NestJS CLI..."
        if command -v nest >/dev/null 2>&1; then
          nest build
        else
          echo "âš ï¸ Usando npx como fallback..."
          npx @nestjs/cli build
        fi
        echo "ğŸ” Verificando se build foi criado..."
        if [ -f "/app/dist/main.js" ]; then
          echo "âœ… Build criado com sucesso!"
          echo "ğŸŒ Iniciando servidor com interface de configuraÃ§Ã£o..."
          echo "âœ… Acesse /api/config para configurar o bot"
          npm run start:prod
        else
          echo "âŒ Build falhou, iniciando em modo desenvolvimento..."
          npm run start:dev
        fi
    volumes:
      - ${APP_DATA_DIR}/data:/data
    environment:
      NODE_ENV: production
