version: '3'

services:
  app:
    image: node:20-alpine
    restart: unless-stopped
    working_dir: /app
    command: >
      sh -c "
        apk add --no-cache git &&
        if [ ! -d .git ]; then
          echo '游닌 Clonando reposit칩rio (primeira instala칞칚o)...'
          git clone https://github.com/samyrwendel/p2ptruscore.git .
        else
          echo '游댃 Atualizando c칩digo do GitHub...'
          git pull origin main
        fi &&
        npm install &&
        echo 'VERIFICANDO se .env j치 existe...' &&
        if [ ! -f /data/.env ]; then
          echo 'CRIANDO .env padr칚o (ser치 substitu칤do pela interface web)...' &&
          echo '# Configura칞칚o do TrustScore Bot' > /data/.env &&
          echo '# Configure via interface web ou edite este arquivo' >> /data/.env &&
          echo '' >> /data/.env &&
          echo '# Token do bot Telegram (obtenha em @BotFather)' >> /data/.env &&
          echo 'TELEGRAM_BOT_TOKEN=CONFIGURE_VIA_WEB_INTERFACE' >> /data/.env &&
          echo '' >> /data/.env &&
          echo '# Username do bot (sem @)' >> /data/.env &&
          echo 'TELEGRAM_BOT_USERNAME=CONFIGURE_VIA_WEB_INTERFACE' >> /data/.env &&
          echo '' >> /data/.env &&
          echo '# IDs dos grupos Telegram (separados por v칤rgula)' >> /data/.env &&
          echo 'TELEGRAM_GROUPS=' >> /data/.env &&
          echo '' >> /data/.env &&
          echo '# MongoDB Connection String' >> /data/.env &&
          echo 'MONGODB_CNN=mongodb://localhost:27017/p2ptruscore' >> /data/.env &&
          echo '' >> /data/.env &&
          echo '# Porta da aplica칞칚o' >> /data/.env &&
          echo 'PORT=3000' >> /data/.env &&
          echo '' >> /data/.env &&
          echo '# Ambiente de execu칞칚o' >> /data/.env &&
          echo 'NODE_ENV=production' >> /data/.env
        else
          echo '.env j치 existe, mantendo configura칞칚o atual...'
        fi &&
        echo '.env criado:' && cat /data/.env &&
        echo 'Copiando .env para /app para compatibilidade...' &&
        cp /data/.env /app/.env &&
        npx ts-node --transpile-only src/main.ts
      "
    ports:
      - "3000:3000"
    volumes:
      - ${APP_DATA_DIR}/data:/data
