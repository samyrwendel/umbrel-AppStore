version: '3.8'

services:
  bot:
    image: node:18-alpine
    restart: unless-stopped
    working_dir: /app
    
    # Comando simplificado para evitar problemas
    command: >
      sh -c "
        echo 'Instalando dependências do sistema...' &&
        apk add --no-cache git &&
        echo 'Clonando repositório...' &&
        git clone https://github.com/samyrwendel/p2ptruscore.git . || true &&
        echo 'Instalando dependências...' &&
        npm install &&
        echo 'Compilando aplicação...' &&
        npm run build &&
        echo 'Iniciando bot...' &&
        npm run start:prod
      "
    
    volumes:
      # Código do app
      - ${APP_DATA_DIR}/code:/app
      # Arquivo de configuração
      - ${APP_DATA_DIR}/config/.env:/app/.env:ro
    
    environment:
      # Variáveis do bot (serão sobrescritas pelo .env se existir)
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      TELEGRAM_BOT_USERNAME: ${TELEGRAM_BOT_USERNAME:-}
      
      # Conexão com MongoDB local
      MONGODB_CNN: mongodb://admin:umbrel@umbrel-br-mongodb_mongo_1:27017/p2ptruscore?authSource=admin
      
      # Porta da API
      PORT: 3000
      
      # Ambiente
      NODE_ENV: production
    
    # Porta da API
    ports:
      - "${APP_HOST_PORT}:3000"
    
    # Rede do MongoDB
    networks:
      - umbrel-br-mongodb_default

networks:
  umbrel-br-mongodb_default:
    external: true