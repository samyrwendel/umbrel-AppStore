version: '3'

services:
  bot:
    image: node:20-alpine
    restart: unless-stopped
    
    command: >
      sh -c "
        cd /app &&
        if [ ! -f package.json ]; then
          echo 'Primeira execução - Clonando repositório...' &&
          apk add --no-cache git &&
          git clone https://github.com/samyrwendel/p2ptruscore.git . &&
          echo 'Instalando dependências globais...' &&
          npm install -g @nestjs/cli &&
          echo 'Instalando dependências do projeto...' &&
          npm install &&
          echo 'Compilando aplicação...' &&
          npm run build
        fi &&
        echo 'P2P TrustScore Bot - Iniciando...' &&
        if [ -f /data/.env ]; then
          cp /data/.env /app/.env
        fi &&
        if [ -d dist ]; then
          npm run start:prod
        else
          echo 'Erro: Aplicação não compilada. Tentando compilar novamente...' &&
          npm install -g @nestjs/cli &&
          npm run build &&
          npm run start:prod
        fi
      "
    
    volumes:
      - ${APP_DATA_DIR}/app:/app
      - ${APP_DATA_DIR}/data:/data
    
    environment:
      NODE_ENV: production
      PORT: 3000
      MONGODB_CNN: mongodb://admin:umbrel@host.docker.internal:27017/p2ptruscore?authSource=admin
    
    ports:
      - "${APP_HOST_PORT}:3000"